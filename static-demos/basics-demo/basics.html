<html>
  <head>
    <title>Embedded prebuilt UI demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <link rel="stylesheet" href="./basics.css" />
    <script src="../shared-assets/create-demo-room.js"></script>
  </head>
  <body onload="createFrame()">
    <script>
      function showEvent(e) {
        console.log('callFrame event', e);
      }

      async function createDemoRoom() {
        room = await createMtgRoom();
        ownerLink = await createMtgLinkWithToken(room, {
          is_owner: true,
          enable_recording: 'local',
        });

        let roomInput = document.getElementById('room-url');
        roomInput.value = ownerLink;
      }

      async function joinCall() {
        try {
          callFrame.join({
            url: document.getElementById('room-url').value,
            showLeaveButton: true,
          });
        } catch (error) {
          console.log('error');
          return;
        }
      }

      async function createFrame() {
        callFrame = await window.DailyIframe.createFrame(
          document.getElementById('callframe')
        );

        callFrame
          .on('loaded', showEvent)
          .on('started-camera', showEvent)
          .on('camera-error', showEvent)
          .on('joining-meeting', showEvent)
          .on('recording-started', showEvent)
          .on('recording-stopped', showEvent)
          .on('recording-stats', showEvent)
          .on('recording-error', showEvent)
          .on('app-message', showEvent)
          .on('input-event', showEvent)
          .on('error', showEvent)
          .on('participant-joined', updateParticipantInfoDisplay)
          .on('participant-updated', updateParticipantInfoDisplay)
          .on('participant-left', updateParticipantInfoDisplay);

        callFrame.on('joined-meeting', () => {
          showEvent();
          document.getElementById('call-panel').style.display = 'flex';
          // updateRoomInfoDisplay();
          setInterval(updateNetworkInfoDisplay, 5000);
          // Swap "Create" instructions for "Copy"
          document.getElementById('instruction-text').innerHTML =
            'Copy and share the URL to invite others';
          document.getElementById('join-call').style.display = 'none';
          document.getElementById('create-demo-room').style.display = 'none';
          document.getElementById('copy-link').style.display = 'flex';
          displayDemoRoomTimer();
        });

        callFrame.on('left-meeting', () => {
          showEvent();
          document.getElementById('call-panel').style.display = 'none';
          // Swap "Copy" instructions for "Create"
          document.getElementById('instruction-text').innerHTML =
            'To get started, enter an existing room URL or create a temporary demo room';
          document.getElementById('join-call').style.display = 'flex';
          document.getElementById('create-demo-room').style.display = 'flex';
          document.getElementById('copy-link').style.display = 'none';
          // Clear the input value
          document.getElementById('room-url').value = '';
          // Clear countdown
          document.getElementById('expires-countdown').style.display = 'none';
        });
      }

      function displayDemoRoomTimer() {
        if (!window.expiresUpdate) {
          window.expiresUpdate = setInterval(() => {
            let exp = room && room.config && room.config.exp;
            if (exp) {
              document.getElementById('expires-countdown').innerHTML = `
           <em>Heads up! Your demo room expires in 
             ${Math.floor((new Date(exp * 1000) - Date.now()) / 1000)}
           seconds ‚è≥</em>
         `;
            }
          }, 1000);
        }
      }

      function updateParticipantInfoDisplay(e) {
        showEvent(e);
        let infoEl = document.getElementById('meeting-participants-info'),
          participants = callFrame.participants(),
          infoHTML = '';
        // Get each participant's information and add them to the list
        for (var id in participants) {
          let p = participants[id];
          infoHTML += `
        <li>${p.user_name || 'Guest'} <em>(Cam: ${
            p.video ? 'on' : 'off'
          }, Mic:${p.audio ? 'on' : 'off'})</em></li> 
    `;
        }
        infoEl.innerHTML = infoHTML;
      }

      async function updateNetworkInfoDisplay() {
        let infoEl = document.getElementById('network-info'),
          statsInfo = await callFrame.getNetworkStats();
        infoEl.innerHTML = `
      <li>
        Video send:
        ${Math.floor(statsInfo.stats.latest.videoSendBitsPerSecond / 1000)} kb/s
      </li>
      <li>
        Video recv:
        ${Math.floor(statsInfo.stats.latest.videoRecvBitsPerSecond / 1000)} kb/s
      </li>
      <li>
        Worst send packet loss:
        ${Math.floor(statsInfo.stats.worstVideoSendPacketLoss * 100)}%
      </li>
      <li>Worst recv packet loss:
        ${Math.floor(statsInfo.stats.worstVideoRecvPacketLoss * 100)}%
      </li>
  `;
      }

      function copyLink() {
        let link = document.getElementById('room-url');
        link.select();
        document.execCommand('copy');
        console.log('copied');
      }

      function toggleCameraIcon() {
        callFrame.setLocalVideo(!callFrame.participants().local.video);
        if (!callFrame.participants().local.video) {
          document.getElementById('camera-icon').src = 'assets/camera@2x.png';
        } else {
          document.getElementById('camera-icon').src =
            'assets/camera-off@2x.png';
        }
      }

      function toggleMicIcon() {
        callFrame.setLocalAudio(!callFrame.participants().local.audio);
        if (!callFrame.participants().local.audio) {
          document.getElementById('mic-icon').src = 'assets/mic@2x.png';
        } else {
          document.getElementById('mic-icon').src = 'assets/mic-off@2x.png';
        }
      }
    </script>

    <div id="container">
      <header>
        <img src="assets/logo@2x.png" id="logo" />
        <div>
          <a href="https://github.com/daily-co/daily-demos"
            ><img src="assets/github@icons8.png"
          /></a>
        </div>
      </header>
      <div id="instructions">
        <p id="instruction-text">
          To get started, enter an existing room URL or create a temporary demo
          room
        </p>
        <div id="input-and-buttons">
          <label for="room-url"></label>
          <input type="text" id="room-url" placeholder="Room URL" />
          <button id="copy-link" onclick="copyLink()">Copy room link</button>
          <button id="create-demo-room" onclick="createDemoRoom()">
            Create demo room
          </button>
          <button id="join-call" onclick="joinCall()">Join call</button>
        </div>
        <p id="expires-countdown"></p>
      </div>
      <div id="call-container">
        <div id="callframe"></div>
        <div id="call-panel">
          <div class="info">
            <h2>Call overview</h2>
            <h3>Meeting participants:</h3>
            <ul id="meeting-participants-info"></ul>
          </div>
          <div class="info">
            <h3>Network stats:</h3>
            <ul id="network-info"></ul>
          </div>
          <div class="info">
            <h3>Example custom controls</h3>
            <img
              src="assets/camera@2x.png"
              id="camera-icon"
              onclick="toggleCameraIcon()"
            />
            <img
              src="assets/mic@2x.png"
              id="mic-icon"
              onclick="toggleMicIcon()"
            />
            <!-- Recording  
            https://github.com/daily-co/pluot-core/blob/main/js/components/Icons.js#L2222
            -->
            <!-- Screenshare -->
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
